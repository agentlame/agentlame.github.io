(function(e){var t="http://www.reddit.com/subreddits/mine/moderator.json?count=100",n=(new Date).getTime(),r=JSON.parse(localStorage["Toolbox.cache.lastgetlong"]||-1),i=JSON.parse(localStorage["Toolbox.cache.lastgetshort"]||-1),s=localStorage["Toolbox.cache.cachename"]||"",o=Math.floor(Math.random()*1e3),u=s!=reddit.logged,a=(n-r)/(60*1e3)>30||u,f=(n-i)/(60*1e3)>5||u;e.version=1;e.NO_WIKI_PAGE="NO_WIKI_PAGE";e.WIKI_PAGE_UNKNOWN="WIKI_PAGE_UNKNOWN";e.isModmail=location.pathname.match(/\/message\/(?:moderator)\/?/);e.isModpage=location.pathname.match(/\/about\/(?:reports|modqueue|spam|unmoderated|trials)\/?/),e.isEditUserPage=location.pathname.match(/\/about\/(?:contributors|moderator|banned)\/?/),e.noteCache=f?{}:JSON.parse(localStorage["Toolbox.cache.notecache"]||"{}"),e.configCache=a?{}:JSON.parse(localStorage["Toolbox.cache.configcache"]||"{}"),e.noConfig=f?[]:JSON.parse(localStorage["Toolbox.cache.noconfig"]||"[]"),e.noNotes=f?[]:JSON.parse(localStorage["Toolbox.cache.nonotes"]||"[]"),e.mySubs=a?[]:JSON.parse(localStorage["Toolbox.cache.moderatedsubs"]||"[]");if(u){localStorage["Toolbox.cache.cachename"]=reddit.logged}if(a){localStorage["Toolbox.cache.lastgetlong"]=JSON.stringify(n)}if(f){localStorage["Toolbox.cache.lastgetshort"]=JSON.stringify(n)}e.usernotes={ver:1,users:[]};e.note={note:"",time:"",mod:"",link:""};e.config={ver:1,domainTags:"",removalReasons:"",modMacros:""};e.getID=function(e){e(o)};e.getModSubs=function(n){function r(e){$.getJSON(e,function(e){i(e.data.children,e.data.after)})}function i(i,s){$(i).each(function(){var t=this.data.display_name.trim();if($.inArray(t,e.mySubs)===-1)e.mySubs.push(t)});if(s){var o=t+"&after="+s;r(o)}else{e.mySubs=e.saneSort(e.mySubs);localStorage["Toolbox.cache.moderatedsubs"]=JSON.stringify(e.mySubs);n()}}if(e.mySubs.length<1){e.mySubs=[];r(t)}else{e.mySubs=e.saneSort(e.mySubs);n()}};e.saneSort=function(e){return e.sort(function(e,t){if(e.toLowerCase()<t.toLowerCase())return-1;if(e.toLowerCase()>t.toLowerCase())return 1;return 0})};e.getThingInfo=function(t,n){var r=$(t).find(".author:first").text(),i=$(".titlebox h1.redditname a").text(),s=$(t).closest(".entry").find("a.bylink").attr("href");if(e.isEditUserPage&&!r){r=$(t).closest(".user").find("a:first").text()}if(!r){r=$(t).closest(".entry").find(".author:first").text()}if(!s){s=$(t).closest(".entry").find("a.comments").attr("href")}if(!i){i=$(t).closest(".entry").find(".subreddit").text()}if(!i){i=$(t).closest(".thing").find(".subreddit").text()}if(!i){i=$(t).find(".head a:last").text().replace("/r/","").replace("/","").trim();if(!r&&$(t).find(".remove-button").text()===""){r=reddit.logged;if(!i){i=$(t).closest(".message-parent").find(".correspondent.reddit.rounded a").text().replace("/r/","").replace("[-]","").replace("[+]","").trim()}}}if(n&&$.inArray(i,e.mySubs)===-1){i=""}if(r=="[deleted]"){r=""}return{subreddit:i,user:r,permalink:s}};e.forEachChunked=function(e,t,n,r,i){function u(){for(var o=Math.min(e.length,s+t);s<o;s++){var a=r(e[s],s,e);if(a===false)return}if(s<e.length){window.setTimeout(u,n)}else{if(i)i()}}if(e==null)return;if(t==null||t<1)return;if(n==null||n<0)return;if(r==null)return;var s=0;var o=e.length;window.setTimeout(u,n)};e.postToWiki=function(e,t,n,r,i,s){if(r){n=JSON.stringify(n,undefined,2)}$.post("/r/"+t+"/api/wiki/edit",{content:n,page:e,reason:"updated via toolbox config",uh:reddit.modhash}).error(function(e){s(false,e.responseText)}).success(function(){s(true);if(i){$.post("/api/compose",{to:"automoderator",uh:reddit.modhash,subject:t,text:"update"}).success(function(){alert("sucessfully sent update PM to automoderator")}).error(function(){alert("error sending update PM to automoderator");window.location="http://www.reddit.com/message/compose/?to=AutoModerator&subject="+t+"&message=update"})}setTimeout(function(){$.post("/r/"+t+"/wiki/settings/"+e,{permlevel:2,uh:reddit.modhash}).error(function(n){alert("error setting wiki page to mod only access");window.location="http://www.reddit.com/r/"+t+"/wiki/settings/"+e})},500)})};e.readFromWiki=function(t,n,r,i){$.getJSON("http://www.reddit.com/r/"+t+"/wiki/"+n+".json",function(t){var n=t.data.content_md;if(!n){i(e.NO_WIKI_PAGE);return}if(r){n=JSON.parse(n);if(n){i(n)}else{i(e.NO_WIKI_PAGE)}return}i(n);return}).error(function(t){var n=JSON.parse(t.responseText).reason||"";if(n=="PAGE_NOT_CREATED"||n=="WIKI_DISABLED"){i(e.NO_WIKI_PAGE)}else{i(e.WIKI_PAGE_UNKNOWN)}})};e.compressHTML=function(e){return e.replace(/(\n+|\s+)?</g,"<").replace(/>(\n+|\s+)?/g,">").replace(/&/g,"&").replace(/\n/g,"").replace(/child" >  False/,'child">')};e.getReasosnFromCSS=function(e,t){$.get("http://www.reddit.com/r/"+e+"/about/stylesheet.json").success(function(e){if(!e.data){t(false);return}var n=e.data.stylesheet.replace(/\n+|\s+/g," ").replace(/</g,"<").replace(/>/g,">").match(/<removereasons2>.+<\/removereasons2>/i);if(!n){n=e.data.stylesheet.replace(/\n+|\s+/g," ").replace(/</g,"<").replace(/>/g,">").match(/<removereasons>.+<\/removereasons>/i)}if(!n){t(false);return}var r=$(n[0]);var i=[];r.find("reason").each(function(){var e={text:escape(this.innerHTML)};i.push(e)});var s={pmsubject:r.find("pmsubject").text()||"",logreason:r.find("logreason").text()||"",header:escape(r.find("header").text()||""),footer:escape(r.find("footer").text()||""),logsub:r.find("logsub").text()||"",logtitle:r.find("logtitle").text()||"",bantitle:r.find("bantitle").text()||"",getfrom:r.find("getfrom").text()||"",reasons:i};t(s)}).error(function(){t(false)})};window.onbeforeunload=function(){localStorage["Toolbox.cache.configcache"]=JSON.stringify(e.configCache);localStorage["Toolbox.cache.notecache"]=JSON.stringify(e.noteCache);localStorage["Toolbox.cache.noconfig"]=JSON.stringify(e.noConfig);localStorage["Toolbox.cache.nonotes"]=JSON.stringify(e.noNotes)}})(TBUtils=window.TBUtils||{})
