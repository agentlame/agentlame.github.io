(function(j){console.log('loading toolbox utils')var k=[],modMineURL='http://www.reddit.com/subreddits/mine/moderator.json?count=100',lastget=JSON.parse(localStorage['Toolbox.cache.lastget']||-1),cachename=localStorage['Toolbox.cache.cachename']||'';j.version=1;j.NO_WIKI_PAGE='NO_WIKI_PAGE';j.WIKI_PAGE_UNKNOWN='WIKI_PAGE_UNKNOWN';j.isModmail=location.pathname.match(/\/message\/(?:moderator)\/?/);j.isModpage=location.pathname.match(/\/about\/(?:reports|modqueue|spam|unmoderated|trials)\/?/),j.isEditUserPage=location.pathname.match(/\/about\/(?:contributors|moderator|banned)\/?/),j.noteCache=[],j.configCache=[],j.noConfig=[],j.noNotes=[];j.usernotes={ver:1,users:[]};j.note={note:'',time:'',mod:'',link:''};j.config={ver:1,domainTags:'',removalReasons:'',modMacros:'',};j.getModSubs=function(e){if(localStorage['Toolbox.cache.moderatedsubs']){k=JSON.parse(localStorage['Toolbox.cache.moderatedsubs'])}if(k.length<1||(new Date().getTime()-lastget)/(1000*60)>30||cachename!=reddit.logged){k=[];getSubs(modMineURL)}else{k=j.saneSort(k);e(k)}function getSubs(b){$.getJSON(b,function(a){getSubsResult(a.data.children,a.data.after)})}function getSubsResult(b,c){$(b).each(function(a){k.push(this.data.display_name.trim())});if(c){var d=modMineURL+'&after='+c;getSubs(d)}else{lastget=new Date().getTime();cachename=reddit.logged;k=j.saneSort(k);localStorage['Toolbox.cache.moderatedsubs']=JSON.stringify(k);localStorage['Toolbox.cache.lastget']=JSON.stringify(lastget);localStorage['Toolbox.cache.cachename']=cachename;e(k)}}};j.saneSort=function(c){return c.sort(function(a,b){if(a.toLowerCase()<b.toLowerCase())return-1;if(a.toLowerCase()>b.toLowerCase())return 1;return 0})};j.getThingInfo=function(a,b){var c=$(a).find('.author:first').text(),subreddit=$('.titlebox h1.redditname a').text(),permalink=$(a).closest('.entry').find('a.bylink').attr('href');if(j.isEditUserPage&&!c){c=$(a).closest('.user').find('a:first').text()}if(!c){c=$(a).closest('.entry').find('.author:first').text()}if(!permalink){permalink=$(a).closest('.entry').find('a.comments').attr('href')}if(!subreddit){subreddit=$(a).closest('.entry').find('.subreddit').text()}if(!subreddit){subreddit=$(a).closest('.thing').find('.subreddit').text()}if(!subreddit){subreddit=$(a).find('.head a:last').text().replace('/r/','').replace('/','').trim();if(!c&&$(a).find('.remove-button').text()===''){c=reddit.logged;if(!subreddit){subreddit=$(a).closest('.message-parent').find('.correspondent.reddit.rounded a').text().replace('/r/','').replace('[-]','').replace('[+]','').trim()}}}if(b&&$.inArray(subreddit,k)===-1){subreddit=''}if(c=='[deleted]'){c=''}return{subreddit:subreddit,user:c,permalink:permalink}};j.forEachChunked=function(c,d,e,f,g){if(c==null)return;if(d==null||d<1)return;if(e==null||e<0)return;if(f==null)return;var h=0;var i=c.length;function doChunk(){for(var a=Math.min(c.length,h+d);h<a;h++){var b=f(c[h],h,c);if(b===false)return}if(h<c.length){window.setTimeout(doChunk,e)}else{if(g)g()}}window.setTimeout(doChunk,e)};j.postToWiki=function(b,c,d,e,f,g){if(e){d=JSON.stringify(d,undefined,2)}$.post('/r/'+c+'/api/wiki/edit',{content:d,page:b,reason:'updated via toolbox config',uh:reddit.modhash}).error(function(a){g(false,a.responseText)}).success(function(){g(true);if(f){$.post('/api/compose',{to:'automoderator',uh:reddit.modhash,subject:c,text:'update'}).success(function(){alert('sucessfully sent update PM to automoderator')}).error(function(){alert('error sending update PM to automoderator');window.location='http://www.reddit.com/message/compose/?to=AutoModerator&subject='+c+'&message=update'})}setTimeout(function(){$.post('/r/'+c+'/wiki/settings/'+b,{permlevel:2,uh:reddit.modhash}).error(function(a){alert('error setting wiki page to mod only access');window.location='http://www.reddit.com/r/'+c+'/wiki/settings/'+b})},500)})};j.readFromWiki=function(c,d,f,g){$.getJSON('http://www.reddit.com/r/'+c+'/wiki/'+d+'.json',function(a){var b=a.data.content_md;if(!b){g(j.NO_WIKI_PAGE);return}if(f){b=JSON.parse(b);if(b){g(b)}else{g(j.NO_WIKI_PAGE)}return}g(b);return}).error(function(e){var a=JSON.parse(e.responseText).reason||'';if(a=='PAGE_NOT_CREATED'||a=='WIKI_DISABLED'){g(j.NO_WIKI_PAGE)}else{g(j.WIKI_PAGE_UNKNOWN)}})};j.compressHTML=function(a){return a.replace(/(\n+|\s+)?&lt;/g,'<').replace(/&gt;(\n+|\s+)?/g,'>').replace(/&amp;/g,'&').replace(/\n/g,'').replace(/child" >  False/,'child">')}}(TBUtils=window.TBUtils||{}));
