(function(e){console.log("loading toolbox utils");var t=[],n="http://www.reddit.com/subreddits/mine/moderator.json?count=100",r=JSON.parse(localStorage["Toolbox.cache.lastget"]||-1),i=localStorage["Toolbox.cache.cachename"]||"";e.version=1;e.NO_WIKI_PAGE="NO_WIKI_PAGE";e.WIKI_PAGE_UNKNOWN="WIKI_PAGE_UNKNOWN";e.isModmail=location.pathname.match(/\/message\/(?:moderator)\/?/);e.isModpage=location.pathname.match(/\/about\/(?:reports|modqueue|spam|unmoderated|trials)\/?/),e.isEditUserPage=location.pathname.match(/\/about\/(?:contributors|moderator|banned)\/?/),e.noteCache=[],e.configCache=[],e.noConfig=[],e.noNotes=[];e.usernotes={ver:1,users:[]};e.note={note:"",time:"",mod:"",link:""};e.config={ver:1,domainTags:"",removalReasons:"",modMacros:""};e.getModSubs=function(s){function o(e){$.getJSON(e,function(e){u(e.data.children,e.data.after)})}function u(u,a){$(u).each(function(e){t.push(this.data.display_name.trim())});if(a){var f=n+"&after="+a;o(f)}else{r=(new Date).getTime();i=reddit.logged;t=e.saneSort(t);localStorage["Toolbox.cache.moderatedsubs"]=JSON.stringify(t);localStorage["Toolbox.cache.lastget"]=JSON.stringify(r);localStorage["Toolbox.cache.cachename"]=i;s(t)}}if(localStorage["Toolbox.cache.moderatedsubs"]){t=JSON.parse(localStorage["Toolbox.cache.moderatedsubs"])}if(t.length<1||((new Date).getTime()-r)/(1e3*60)>30||i!=reddit.logged){t=[];o(n)}else{t=e.saneSort(t);s(t)}};e.saneSort=function(e){return e.sort(function(e,t){if(e.toLowerCase()<t.toLowerCase())return-1;if(e.toLowerCase()>t.toLowerCase())return 1;return 0})};e.getThingInfo=function(n,r){var i=$(n).find(".author:first").text(),s=$(".titlebox h1.redditname a").text(),o=$(n).closest(".entry").find("a.bylink").attr("href");if(e.isEditUserPage&&!i){i=$(n).closest(".user").find("a:first").text()}if(!i){i=$(n).closest(".entry").find(".author:first").text()}if(!o){o=$(n).closest(".entry").find("a.comments").attr("href")}if(!s){s=$(n).closest(".entry").find(".subreddit").text()}if(!s){s=$(n).closest(".thing").find(".subreddit").text()}if(!s){s=$(n).find(".head a:last").text().replace("/r/","").replace("/","").trim();if(!i&&$(n).find(".remove-button").text()===""){i=reddit.logged;if(!s){s=$(n).closest(".message-parent").find(".correspondent.reddit.rounded a").text().replace("/r/","").replace("[-]","").replace("[+]","").trim()}}}if(r&&$.inArray(s,t)===-1){s=""}if(i=="[deleted]"){i=""}return{subreddit:s,user:i,permalink:o}};e.forEachChunked=function(e,t,n,r,i){function u(){for(var o=Math.min(e.length,s+t);s<o;s++){var a=r(e[s],s,e);if(a===false)return}if(s<e.length){window.setTimeout(u,n)}else{if(i)i()}}if(e==null)return;if(t==null||t<1)return;if(n==null||n<0)return;if(r==null)return;var s=0;var o=e.length;window.setTimeout(u,n)};e.postToWiki=function(e,t,n,r,i,s){if(r){n=JSON.stringify(n,undefined,2)}$.post("/r/"+t+"/api/wiki/edit",{content:n,page:e,reason:"updated via toolbox config",uh:reddit.modhash}).error(function(e){s(false,e.responseText)}).success(function(){s(true);if(i){$.post("/api/compose",{to:"automoderator",uh:reddit.modhash,subject:t,text:"update"}).success(function(){alert("sucessfully sent update PM to automoderator")}).error(function(){alert("error sending update PM to automoderator");window.location="http://www.reddit.com/message/compose/?to=AutoModerator&subject="+t+"&message=update"})}setTimeout(function(){$.post("/r/"+t+"/wiki/settings/"+e,{permlevel:2,uh:reddit.modhash}).error(function(n){alert("error setting wiki page to mod only access");window.location="http://www.reddit.com/r/"+t+"/wiki/settings/"+e})},500)})};e.readFromWiki=function(t,n,r,i){$.getJSON("http://www.reddit.com/r/"+t+"/wiki/"+n+".json",function(t){var n=t.data.content_md;if(!n){i(e.NO_WIKI_PAGE);return}if(r){n=JSON.parse(n);if(n){i(n)}else{i(e.NO_WIKI_PAGE)}return}i(n);return}).error(function(t){var n=JSON.parse(t.responseText).reason||"";if(n=="PAGE_NOT_CREATED"||n=="WIKI_DISABLED"){i(e.NO_WIKI_PAGE)}else{i(e.WIKI_PAGE_UNKNOWN)}})};e.compressHTML=function(e){return e.replace(/(\n+|\s+)?</g,"<").replace(/>(\n+|\s+)?/g,">").replace(/&/g,"&").replace(/\n/g,"").replace(/child" >  False/,'child">')}})(TBUtils=window.TBUtils||{})
