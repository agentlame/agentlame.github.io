(function(e){var t="http://www.reddit.com/subreddits/mine/moderator.json?count=100",n=(new Date).getTime(),r=JSON.parse(localStorage["Toolbox.cache.lastgetlong"]||-1),i=JSON.parse(localStorage["Toolbox.cache.lastgetshort"]||-1),s=JSON.parse(localStorage["Toolbox.cache.shortlength"]||15),o=JSON.parse(localStorage["Toolbox.cache.longlength"]||45),u=localStorage["Toolbox.cache.cachename"]||"",a=Math.floor(Math.random()*1e3),f=u!=reddit.logged,l=(n-r)/(60*1e3)>o||f,c=(n-i)/(60*1e3)>s||f;e.version=1;e.NO_WIKI_PAGE="NO_WIKI_PAGE";e.WIKI_PAGE_UNKNOWN="WIKI_PAGE_UNKNOWN";e.isModmail=location.pathname.match(/\/message\/(?:moderator)\/?/);e.isModpage=location.pathname.match(/\/about\/(?:reports|modqueue|spam|unmoderated|trials)\/?/),e.isEditUserPage=location.pathname.match(/\/about\/(?:contributors|moderator|banned)\/?/),e.noteCache=c?{}:JSON.parse(localStorage["Toolbox.cache.notecache"]||"{}"),e.configCache=l?{}:JSON.parse(localStorage["Toolbox.cache.configcache"]||"{}"),e.noConfig=c?[]:JSON.parse(localStorage["Toolbox.cache.noconfig"]||"[]"),e.noNotes=c?[]:JSON.parse(localStorage["Toolbox.cache.nonotes"]||"[]"),e.mySubs=l?[]:JSON.parse(localStorage["Toolbox.cache.moderatedsubs"]||"[]");if(f){localStorage["Toolbox.cache.cachename"]=reddit.logged}if(l){localStorage["Toolbox.cache.lastgetlong"]=JSON.stringify(n)}if(c){localStorage["Toolbox.cache.lastgetshort"]=JSON.stringify(n)}e.usernotes={ver:1,users:[]};e.note={note:"",time:"",mod:"",link:""};e.config={ver:1,domainTags:"",removalReasons:"",modMacros:""};e.getID=function(e){e(a)};e.notification=function(e,t,n){var r=true;if(r===false){return}$.sticky=function(e,t,n){return $.fn.sticky(e,t,n)};$.fn.sticky=function(e,t,n){var r="bottom-right";var i={speed:"fast",duplicates:true,autoclose:15e3};if(!e){e=this.html()}if(t){$.extend(i,t)}var s=true;var o="no";var u=Math.floor(Math.random()*99999);$(".sticky-note").each(function(){if($(this).html()==e&&$(this).is(":visible")){o="yes";if(!i.duplicates){s=false}}if($(this).attr("id")==u){u=Math.floor(Math.random()*9999999)}});if(!$("body").find(".sticky-queue").html()){$("body").append('<div class="sticky-queue '+r+'"></div>')}if(s){$(".sticky-queue").prepend('<div class="sticky border-'+r+'" id="'+u+'"></div>');$("#"+u).append('<img src="http://creesch.github.io/reddit-declutter/close.png" class="sticky-close" rel="'+u+'" title="Close" />');$("#"+u).append('<div class="sticky-note" rel="'+u+'">'+e+"</div>");var a=$("#"+u).height();$("#"+u).css("height",a);$("#"+u).slideDown(i.speed);s=true}$(".sticky").ready(function(){if(i.autoclose){$("#"+u).delay(i.autoclose).fadeOut(i.speed)}});$(".sticky-close").click(function(){$("#"+$(this).attr("rel")).dequeue().fadeOut(i.speed)});var f={id:u,duplicate:o,displayed:s,position:r};if(n){n(f)}else{return f}};if(!window.Notification&&!window.webkitNotifications){$.sticky("<strong>"+e+'</strong><br><p><a href="'+n+'">'+t+"<a></p>")}else if(window.Notification&&navigator.userAgent.indexOf("Firefox")!==-1){window.Notification.requestPermission(function(r){if(r=="granted"){new window.Notification(e,{dir:"auto",body:t,icon:"http://creesch.github.io/reddit-declutter/reddit-icon.png",onshow:function(){setTimeout(notification.close(),15e3)},onclick:function(){window.open(n);this.cancel()}})}})}else if(window.webkitNotifications){if(window.webkitNotifications.checkPermission()===0){var i=window.webkitNotifications.createNotification("http://creesch.github.io/reddit-declutter/reddit-icon.png",e,t);i.ondisplay=function(e){setTimeout(function(){e.currentTarget.cancel()},1e4)};i.onclick=function(){window.open(n);this.cancel()};i.show()}else if(window.webkitNotifications.checkPermission()==2){$.sticky("<strong>"+e+'</strong><br><p><a href="'+n+'">'+t+"<a></p>")}else{$('<div id="tb-notification-permission">An toolbox script would like to use native desktop notifications. Click here to allow or deny this, when denied the it will use build in notifications <br>Note: notifications can be disabled in preferences.</div>').appendTo("body").click(function(){window.webkitNotifications.requestPermission();$(this).remove()})}}};e.getModSubs=function(n){function r(e){$.getJSON(e,function(e){i(e.data.children,e.data.after)})}function i(i,s){$(i).each(function(){var t=this.data.display_name.trim();if($.inArray(t,e.mySubs)===-1)e.mySubs.push(t)});if(s){var o=t+"&after="+s;r(o)}else{e.mySubs=e.saneSort(e.mySubs);localStorage["Toolbox.cache.moderatedsubs"]=JSON.stringify(e.mySubs);n()}}if(e.mySubs.length<1){e.mySubs=[];r(t)}else{e.mySubs=e.saneSort(e.mySubs);n()}};e.saneSort=function(e){return e.sort(function(e,t){if(e.toLowerCase()<t.toLowerCase())return-1;if(e.toLowerCase()>t.toLowerCase())return 1;return 0})};e.getThingInfo=function(t,n){var r=$(t).find(".author:first").text(),i=$(".titlebox h1.redditname a").text(),s=$(t).closest(".entry").find("a.bylink").attr("href");if(e.isEditUserPage&&!r){r=$(t).closest(".user").find("a:first").text()}if(!r){r=$(t).closest(".entry").find(".author:first").text()}if(!s){s=$(t).closest(".entry").find("a.comments").attr("href")}if(!i){i=$(t).closest(".entry").find(".subreddit").text()}if(!i){i=$(t).closest(".thing").find(".subreddit").text()}if(!i){i=$(t).find(".head a:last").text().replace("/r/","").replace("/","").trim();if(!r&&$(t).find(".remove-button").text()===""){r=reddit.logged;if(!i){i=$(t).closest(".message-parent").find(".correspondent.reddit.rounded a").text().replace("/r/","").replace("[-]","").replace("[+]","").trim()}}}if(n&&$.inArray(i,e.mySubs)===-1){i=""}if(r=="[deleted]"){r=""}return{subreddit:i,user:r,permalink:s}};e.forEachChunked=function(e,t,n,r,i){function u(){for(var o=Math.min(e.length,s+t);s<o;s++){var a=r(e[s],s,e);if(a===false)return}if(s<e.length){window.setTimeout(u,n)}else{if(i)i()}}if(e==null)return;if(t==null||t<1)return;if(n==null||n<0)return;if(r==null)return;var s=0;var o=e.length;window.setTimeout(u,n)};e.postToWiki=function(e,t,n,r,i,s){if(r){n=JSON.stringify(n,undefined,2)}$.post("/r/"+t+"/api/wiki/edit",{content:n,page:e,reason:"updated via toolbox config",uh:reddit.modhash}).error(function(e){s(false,e.responseText)}).success(function(){s(true);if(i){$.post("/api/compose",{to:"automoderator",uh:reddit.modhash,subject:t,text:"update"}).success(function(){alert("sucessfully sent update PM to automoderator")}).error(function(){alert("error sending update PM to automoderator");window.location="http://www.reddit.com/message/compose/?to=AutoModerator&subject="+t+"&message=update"})}setTimeout(function(){$.post("/r/"+t+"/wiki/settings/"+e,{permlevel:2,uh:reddit.modhash}).error(function(n){alert("error setting wiki page to mod only access");window.location="http://www.reddit.com/r/"+t+"/wiki/settings/"+e})},500)})};e.readFromWiki=function(t,n,r,i){$.getJSON("http://www.reddit.com/r/"+t+"/wiki/"+n+".json",function(t){var n=t.data.content_md;if(!n){i(e.NO_WIKI_PAGE);return}if(r){n=JSON.parse(n);if(n){i(n)}else{i(e.NO_WIKI_PAGE)}return}i(n);return}).error(function(t){var n=JSON.parse(t.responseText).reason||"";if(n=="PAGE_NOT_CREATED"||n=="WIKI_DISABLED"){i(e.NO_WIKI_PAGE)}else{i(e.WIKI_PAGE_UNKNOWN)}})};e.compressHTML=function(e){return e.replace(/(\n+|\s+)?</g,"<").replace(/>(\n+|\s+)?/g,">").replace(/&/g,"&").replace(/\n/g,"").replace(/child" >  False/,'child">')};e.getReasosnFromCSS=function(e,t){$.get("http://www.reddit.com/r/"+e+"/about/stylesheet.json").success(function(e){if(!e.data){t(false);return}var n=e.data.stylesheet.replace(/\n+|\s+/g," ").replace(/</g,"<").replace(/>/g,">").match(/<removereasons2>.+<\/removereasons2>/i);if(!n){n=e.data.stylesheet.replace(/\n+|\s+/g," ").replace(/</g,"<").replace(/>/g,">").match(/<removereasons>.+<\/removereasons>/i)}if(!n){t(false);return}var r=$(n[0]);var i=[];r.find("reason").each(function(){var e={text:escape(this.innerHTML)};i.push(e)});var s={pmsubject:r.find("pmsubject").text()||"",logreason:r.find("logreason").text()||"",header:escape(r.find("header").text()||""),footer:escape(r.find("footer").text()||""),logsub:r.find("logsub").text()||"",logtitle:r.find("logtitle").text()||"",bantitle:r.find("bantitle").text()||"",getfrom:r.find("getfrom").text()||"",reasons:i};t(s)}).error(function(){t(false)})};window.onbeforeunload=function(){localStorage["Toolbox.cache.configcache"]=JSON.stringify(e.configCache);localStorage["Toolbox.cache.notecache"]=JSON.stringify(e.noteCache);localStorage["Toolbox.cache.noconfig"]=JSON.stringify(e.noConfig);localStorage["Toolbox.cache.nonotes"]=JSON.stringify(e.noNotes)}})(TBUtils=window.TBUtils||{})
